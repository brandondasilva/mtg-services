"use strict";function composeMail(a,b,c,d,e){var f=new helper.Content("text/html",d.message),g=new helper.Mail(a,b,c,f);return g.personalizations[0].addSubstitution(new helper.Substitution("-firstname-",d.firstname)),g.personalizations[0].addSubstitution(new helper.Substitution("-lastname-",d.lastname)),g.personalizations[0].addSubstitution(new helper.Substitution("-email-",d.email)),g.personalizations[0].addSubstitution(new helper.Substitution("-subject-",d.subject)),g.setTemplateId(e),sg.emptyRequest({method:"POST",path:"/v3/mail/send",body:g.toJSON()})}function sendgridRequest(a,b){sg.API(a,function(a,c){if(200==c.statusCode||202==c.statusCode)if(void 0==b){var d={attachments:[{fallback:"SendGrid Email Request Successful!",color:"#1BDB6C",pretext:"SendGrid Email Request Successful!",title:"SendGrid Email Request Successful!",text:"The SendGrid request has been sent. Below is the response from SendGrid.",fields:[{title:"Status Code",value:c.statusCode,"short":!0},{title:"Response Body",value:"```"+JSON.stringify(c.body)+"```","short":!1},{title:"Response Headers",value:"```"+JSON.stringify(c.headers)+"```","short":!1}]}]};slackPost(d,process.env.BDS_SLACK_WEBHOOK)}else b.attachments.fallback="SendGrid Contact Request Successful!",b.attachments.pretext="SendGrid Contact Request Successful!",b.attachments.title="SendGrid Contact Request Successful!",b.attachments.fields.push({title:"Status Code",value:c.statusCode,"short":!0},{title:"Response Body",value:"```"+JSON.stringify(c.body)+"```","short":!1},{title:"Response Headers",value:"```"+JSON.stringify(c.headers)+"```","short":!1}),slackPost(b,process.env.BDS_SLACK_WEBHOOK);else{var e={attachments:[{fallback:"SENDGRID REQUEST FAILED",color:"#C10039",pretext:"SENDGRID REQUEST FAILED!",title:"SENDGRID REQUEST FAILED!",text:"The response from SendGrid is displayed below for more information.",fields:[{title:"Status Code",value:c.statusCode,"short":!0},{title:"Response Body",value:"```"+JSON.stringify(c.body)+"```","short":!1},{title:"Response Headers",value:"```"+JSON.stringify(c.headers)+"```","short":!1}]}]};void 0!=b&&(e.attachments.text+="\nThis request is for the SendGrid Contacts API"),slackPost(e,process.env.BDS_SLACK_WEBHOOK)}console.log("--RESPONSE BEGIN--"),console.log(c.statusCode),console.log(c.body),console.log(c.headers),console.log("--RESPONSE END--\n")})}function slackPost(a,b){request({url:b,method:"POST",json:!0,body:a})}function googleSheets(a){authorize(function(b){({spreadsheetId:"1Xj-igcg5c7hWyDWg7vkyThmekbPQ0aMBg1rsDI39Sa4",range:a.range,valueInputOption:"RAW",auth:b,resource:{majorDimension:"ROWS",values:a.values}})})}function authorize(a){if(null==oauth2Client)return void console.log("Google authentication failed");oauth2Client.setCredentials({refresh_token:process.env.GOOGLE_REFRESH_TOKEN}),oauth2Client.refreshAccessToken(function(a,b){a&&console.log(a)});var b=["https://www.googleapis.com/auth/drive.file","https://www.googleapis.com/auth/drive","https://www.googleapis.com/auth/spreadsheets"];oauth2Client.generateAuthUrl({access_type:"offline",scope:b});a(oauth2Client)}var moment=require("moment-timezone"),express=require("express"),request=require("request"),router=express.Router(),helper=require("sendgrid").mail,sg=require("sendgrid")(process.env.SENDGRID_API_KEY),google=require("googleapis"),googleAuth=google.auth.OAuth2,sheets=google.sheets("v4");router.get("/",function(a,b){b.set("Access-Control-Allow-Origin","*"),b.send("API v1 GET: Hello World!")}),router.post("/",function(a,b){b.set("Access-Control-Allow-Origin","*"),console.log(a.body);var c=(a.body.firstname+" "+a.body.lastname,new Date),d=(moment.tz(c,"America/Toronto").format(),new helper.Email("info@medtechgateway.com","Medical Technologies Gateway")),e=new helper.Email("brandon@bdsdesign.co"),f=new helper.Email(a.body.email,a.body.name),g="New contact form submission on the MTG website!",h="Medical Technologies Gateway - Contact Form Submission Confirmation",i=composeMail(d,g,e,a.body,process.env.CONTACT_MTG_TEMPLATE),j=composeMail(d,h,f,a.body,process.env.CONTACT_USER_TEMPLATE),k=(sg.emptyRequest({method:"POST",path:"/v3/contactdb/recipients",body:[{email:a.body.email,first_name:a.body.firstname,last_name:a.body.lastname}]}),{form:{attachments:[{fallback:"A new form on the MTG website has been submitted!",pretext:"A new form on the MTG website has been submitted!",title:"New Contact Form Submission",text:"The contents of the form are outline below for reference.",fields:[{title:"First Name",value:a.body.firstname,"short":!0},{title:"Last Name",value:a.body.lastname,"short":!0},{title:"Email Address",value:a.body.email,"short":!1},{title:"Subject",value:a.body.subject,"short":!1},{title:"Message",value:a.body.message,"short":!1},{title:"Added to mailing list?",value:"true"==a.body.mailinglist?"Yes":"No","short":!1}]}]},mailinglist:{attachments:[{fallback:"A new contact has subscribed to the mailing list!",color:"#1BDB6C",pretext:"A new contact has subscribed to the mailing list!",title:"New Contact Added to the Mailing List",text:"The new subscriber's information and upload status is outlined below.",fields:[{title:"First Name",value:a.body.firstname,"short":!0},{title:"Last Name",value:a.body.lastname,"short":!0},{title:"Email Address",value:a.body.email,"short":!1}]}]}});sendgridRequest(i,void 0),sendgridRequest(j,void 0),slackPost(k.form,process.env.BDS_SLACK_WEBHOOK),b.send(a.body)}),module.exports=router;